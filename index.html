<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Math Checker</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --ok: #16a34a;
      --bad: #dc2626;
      --brand: #2563eb;
      --brand-weak: #dbeafe;
      --border: #e5e7eb;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color: var(--text); background: var(--bg); }

    /* Layout */
    .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h1, h2 { margin: 0 0 .5rem 0; }
    .muted { color: var(--muted); }

    /* Tabs */
    .tabs { max-width: 1000px; margin: 1rem auto .25rem; padding: 0 1rem; display: flex; gap: 8px; border-bottom: 1px solid var(--border); }
    .tab { flex: 1; padding: 10px 12px; cursor: pointer; border: none; background: var(--brand-weak); border-radius: 10px 10px 0 0; font-weight: 600; }
    .tab.active { background: var(--card); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Controls */
    .mode-buttons { display: flex; gap: .5rem; margin: .25rem 0 .75rem; flex-wrap: wrap; }
    .mode-buttons button { border: 1px solid var(--border); background: #fff; padding: .35rem .7rem; border-radius: 9999px; cursor: pointer; font-size: .9rem; }
    .mode-buttons button.active { background: var(--brand-weak); border-color: var(--brand); color: var(--brand); }
    .controls-row { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin:.25rem 0 .5rem; }
    .digit-wrap { display:flex; align-items:center; gap:.4rem; }
    .question { font-size: 2rem; letter-spacing: .5px; text-align: center; margin: .5rem 0 .75rem; }
    .row { display: flex; gap: .5rem; align-items: center; margin: .25rem 0; }
    input[type="number"] { width: 140px; padding: .5rem .6rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); }
    button.primary { background: var(--brand); color: #fff; border: none; padding: .5rem .8rem; border-radius: 8px; cursor: pointer; font-size: .9rem; }
    button.secondary { background: #fff; color: var(--text); border: 1px solid var(--border); padding: .5rem .8rem; border-radius: 8px; cursor: pointer; font-size: .9rem; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .result { min-height: 1.5rem; font-weight: 600; margin-top: .25rem; }
    .ok { color: var(--ok); }
    .bad { color: var(--bad); }
    .timer { font-variant-numeric: tabular-nums; }

    /* Draw tab */
    .pad-header { display:flex; align-items:center; justify-content:space-between; margin-top:.5rem; gap:.75rem; flex-wrap:wrap; }
    .pad-controls { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    #scratchpad { width:100%; height:65vh; background:#fff; border:1px solid var(--border); border-radius:12px; display:block; touch-action:none; user-select:none; -webkit-user-select:none; cursor: crosshair; }
    .size-wrap { display:flex; align-items:center; gap:.4rem; }
    .size-wrap input[type=range] { width: 160px; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: .5rem; margin-top: .5rem; }
    .stat { border: 1px solid var(--border); border-radius: 10px; padding: .5rem; text-align: center; background: #fff; }
    .stat .kpi { font-size: 1.25rem; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <!-- Tabs header: Practice | Draw | Statistics -->
  <div class="tabs" role="tablist" aria-label="Pages">
    <button class="tab active" data-tab="practice" role="tab" aria-selected="true">Practice</button>
    <button class="tab" data-tab="draw" role="tab" aria-selected="false">Draw</button>
    <button class="tab" data-tab="stats" role="tab" aria-selected="false">Statistics</button>
  </div>

  <div class="container">
    <!-- Practice tab -->
    <div id="practice" class="tab-content active" role="tabpanel" aria-labelledby="Practice">
      <main class="card">
        <h1>Math Checker</h1>
        <div class="muted">Practice quick mental arithmetic. Choose a mode, answer, and track your stats.</div>

        <!-- MODE BUTTONS -->
        <div class="mode-buttons" role="group" aria-label="Mode selector">
          <button id="mode-add" aria-pressed="false" type="button">Add</button>
          <button id="mode-sub" aria-pressed="false" type="button">SUB</button>
          <button id="mode-mul" aria-pressed="false" type="button">MULTI</button>
          <button id="mode-both" aria-pressed="false" type="button">Add &amp; Sub</button>
          <button id="mode-all" aria-pressed="true" class="active" type="button">ALL</button>
        </div>

        <!-- Digit selectors -->
        <div class="controls-row">
          <div class="digit-wrap">
            <label for="digitSelect" class="muted">Multiplicand digits:</label>
            <select id="digitSelect">
              <option value="1">1 (0–9)</option>
              <option value="2">2 (0–99)</option>
              <option value="3" selected>3 (0–999)</option>
              <option value="4">4 (0–9999)</option>
            </select>
            <span id="digitRangeLabel" class="muted">Range: 0–999</span>
          </div>

          <div class="digit-wrap">
            <label for="multiplierDigitSelect" class="muted">Multiplier digits:</label>
            <select id="multiplierDigitSelect">
              <option value="1" selected>1 (0–9)</option>
              <option value="2">2 (0–99)</option>
              <option value="3">3 (0–999)</option>
              <option value="4">4 (0–9999)</option>
            </select>
            <span id="multiplierRangeLabel" class="muted">Range: 0–9</span>
          </div>

          <div class="muted" style="margin-left:auto">Time: <span id="timer" class="timer" aria-live="polite">0.0s</span></div>
        </div>

        <div id="question" class="question" aria-live="polite">0 + 0</div>

        <div class="row">
          <label for="answer" class="muted" style="width:70px">Answer</label>
          <input id="answer" type="number" inputmode="numeric" min="0" max="999" placeholder="0–999" />
          <button id="checkBtn" class="primary" type="button" disabled>Check</button>
          <button id="nextBtn" class="secondary" type="button" disabled>Next</button>
        </div>

        <div id="result" class="result" aria-live="polite"></div>
        <div id="correctValue" class="muted" style="min-height:1rem" aria-live="polite"></div>
      </main>
    </div>

    <!-- Draw tab -->
    <div id="draw" class="tab-content" role="tabpanel" aria-labelledby="Draw">
      <section class="card">
        <h2 style="margin-top:0">Drawing Pad</h2>
        <div class="muted">Use your mouse or finger to draw. Great for working out problems.</div>
        <div class="pad-header">
          <div class="pad-controls">
            <div class="size-wrap">
              <span class="muted">Pen size</span>
              <input id="sizeInput" type="range" min="1" max="20" step="1" value="10" />
              <span id="sizeValue" class="muted">10</span>
            </div>
            <button id="clearPadBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
        <canvas id="scratchpad" aria-label="Drawing area"></canvas>
      </section>
    </div>

    <!-- Statistics tab -->
    <div id="stats" class="tab-content" role="tabpanel" aria-labelledby="Statistics">
      <aside class="card">
        <h2 style="margin-top:0">Statistics</h2>
        <div class="stats-grid">
          <div class="stat"><div class="muted">Total</div><div id="totalCount" class="kpi">0</div></div>
          <div class="stat"><div class="muted">Correct</div><div id="correctCount" class="kpi">0</div></div>
          <div class="stat"><div class="muted">Incorrect</div><div id="incorrectCount" class="kpi">0</div></div>
          <div class="stat"><div class="muted">Accuracy</div><div id="correctRate" class="kpi">0.0%</div></div>
        </div>
        <div class="row" style="margin-top:.5rem; justify-content:space-between">
          <button id="resetStats" class="secondary" type="button">Reset Stats</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ---------------------------
    // Storage & constants
    // ---------------------------
    const STORAGE = {
      digitCount: "math999_digitCount",                 // multiplicand digits
      multiplierDigitCount: "math999_multiplierDigitCount", // multiplier digits
      mode: "math999_mode",
      stats: "math999_stats",
    };

    const Modes = Object.freeze({
      ADD: "add",
      SUB: "sub",
      MUL: "mul",
      BOTH: "both",
      ALL: "all",
    });

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function randIntInclusive(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    // ---------------------------
    // Digit state (independent selectors)
    // ---------------------------
    function getStoredDigits() {
      const d = parseInt(localStorage.getItem(STORAGE.digitCount), 10);
      return [1,2,3,4].includes(d) ? d : 3; // default multiplicand = 3 digits
    }
    function getStoredMultiplierDigits() {
      const d = parseInt(localStorage.getItem(STORAGE.multiplierDigitCount), 10);
      return [1,2,3,4].includes(d) ? d : 1; // default multiplier = 1 digit
    }

    let digitCount = getStoredDigits();
    let multiplierDigitCount = getStoredMultiplierDigits();

    function currentMaxNumber() { return Math.pow(10, digitCount) - 1; }
    function currentMaxMultiplierNumber() { return Math.pow(10, multiplierDigitCount) - 1; }

    function updateDigitUI() {
      const sel = document.getElementById("digitSelect");
      const label = document.getElementById("digitRangeLabel");
      const msel = document.getElementById("multiplierDigitSelect");
      const mlabel = document.getElementById("multiplierRangeLabel");
      const maxN = currentMaxNumber();
      const maxM = currentMaxMultiplierNumber();
      if (sel) sel.value = String(digitCount);
      if (label) label.textContent = `Range: 0–${maxN}`;
      if (msel) msel.value = String(multiplierDigitCount);
      if (mlabel) mlabel.textContent = `Range: 0–${maxM}`;
    }

    // ---------------------------
    // Mode state
    // ---------------------------
    function getStoredMode() {
      const m = localStorage.getItem(STORAGE.mode);
      return [Modes.ADD, Modes.SUB, Modes.MUL, Modes.BOTH, Modes.ALL].includes(m) ? m : Modes.ALL;
    }
    let mode = getStoredMode();

    function updateModeUI() {
      const btnAdd = document.getElementById("mode-add");
      const btnSub = document.getElementById("mode-sub");
      const btnMul = document.getElementById("mode-mul");
      const btnBoth = document.getElementById("mode-both");
      const btnAll = document.getElementById("mode-all");
      const map = { [Modes.ADD]: btnAdd, [Modes.SUB]: btnSub, [Modes.MUL]: btnMul, [Modes.BOTH]: btnBoth, [Modes.ALL]: btnAll };
      [btnAdd,btnSub,btnMul,btnBoth,btnAll].forEach(b => { if (b){ b.classList.remove("active"); b.setAttribute("aria-pressed","false"); } });
      const active = map[mode];
      if (active) { active.classList.add("active"); active.setAttribute("aria-pressed","true"); }
    }

    // ---------------------------
    // Stats
    // ---------------------------
    const defaultStats = { total: 0, correct: 0, incorrect: 0 };
    function loadStats() {
      try {
        const raw = localStorage.getItem(STORAGE.stats);
        if (!raw) return { ...defaultStats };
        const obj = JSON.parse(raw);
        return { ...defaultStats, ...obj };
      } catch { return { ...defaultStats }; }
    }
    function saveStats() { localStorage.setItem(STORAGE.stats, JSON.stringify(stats)); }
    let stats = loadStats();

    function renderStats() {
      const { total, correct, incorrect } = stats;
      const rate = total ? ((correct / total) * 100).toFixed(1) : "0.0";
      document.getElementById("totalCount").textContent = String(total);
      document.getElementById("correctCount").textContent = String(correct);
      document.getElementById("incorrectCount").textContent = String(incorrect);
      document.getElementById("correctRate").textContent = `${rate}%`;
    }

    // ---------------------------
    // Question generation
    // ---------------------------
    let current = { a: 0, b: 0, op: "+", answer: 0 };
    const qEl = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const resultEl = document.getElementById("result");
    const correctValEl = document.getElementById("correctValue");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");

    function generateOperands() {
      const maxN = currentMaxNumber();
      const maxM = currentMaxMultiplierNumber();
      let a = 0, b = 0;

      if (mode === Modes.MUL) {
        a = randIntInclusive(0, maxN);   // multiplicand
        b = randIntInclusive(0, maxM);   // multiplier (independent)
        return { a, b, op: "×", answer: a * b };
      }

      if (mode === Modes.SUB) {
        a = randIntInclusive(0, maxN);
        b = randIntInclusive(0, maxN);
        if (b > a) [a, b] = [b, a];
        return { a, b, op: "−", answer: a - b };
      }

      if (mode === Modes.ADD) {
        a = randIntInclusive(0, maxN);
        b = randIntInclusive(0, maxN);
        return { a, b, op: "+", answer: a + b };
      }

      if (mode === Modes.BOTH) {
        a = randIntInclusive(0, maxN);
        b = randIntInclusive(0, maxN);
        if (Math.random() < 0.5) {
          if (b > a) [a, b] = [b, a];
          return { a, b, op: "−", answer: a - b };
        } else {
          return { a, b, op: "+", answer: a + b };
        }
      }

      // Modes.ALL -> random among +, −, ×
      const r = Math.random();
      if (r < 1/3) {
        a = randIntInclusive(0, maxN); b = randIntInclusive(0, maxN);
        return { a, b, op: "+", answer: a + b };
      } else if (r < 2/3) {
        a = randIntInclusive(0, maxN); b = randIntInclusive(0, maxN);
        if (b > a) [a, b] = [b, a];
        return { a, b, op: "−", answer: a - b };
      } else {
        a = randIntInclusive(0, maxN); b = randIntInclusive(0, maxM);
        return { a, b, op: "×", answer: a * b };
      }
    }

    function renderQuestion() { qEl.textContent = `${current.a} ${current.op} ${current.b}`; }

    function updateAnswerConstraints() {
      const maxN = currentMaxNumber();
      const maxM = currentMaxMultiplierNumber();
      let maxAnswer;
      if (current.op === "+") maxAnswer = maxN * 2;            // e.g., 99 + 99 = 198 OK
      else if (current.op === "−") maxAnswer = maxN;           // non-negative by design
      else if (current.op === "×") maxAnswer = maxN * maxM;    // product upper bound
      else maxAnswer = maxN;
      answerEl.min = "0";
      answerEl.max = String(maxAnswer);
      answerEl.placeholder = `0–${maxAnswer}`;
    }

    // ---------------------------
    // Timer
    // ---------------------------
    const timerEl = document.getElementById("timer");
    let tStart = 0, tHandle = null;
    function formatSeconds(ms) { return (ms / 1000).toFixed(1) + "s"; }
    function startTimer() {
      stopTimer();
      tStart = performance.now();
      tHandle = setInterval(() => { timerEl.textContent = formatSeconds(performance.now() - tStart); }, 100);
    }
    function stopTimer() { if (tHandle) clearInterval(tHandle); tHandle = null; }

    // ---------------------------
    // Draw pad
    // ---------------------------
    const canvas = document.getElementById("scratchpad");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    const sizeInput = document.getElementById("sizeInput");
    const sizeValue = document.getElementById("sizeValue");
    const clearPadBtn = document.getElementById("clearPadBtn");

    function resizeCanvasToCSS() {
      const { width, height } = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(width * dpr);
      canvas.height = Math.floor(height * dpr);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }

    let drawing = false, last = null;
    function getPoint(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches[0]) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
    function setStrokeWidth(w) { ctx.lineWidth = clamp(w, 1, 20); sizeValue.textContent = String(ctx.lineWidth); }
    function clearDrawingArea() { ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.restore(); }

    // ---------------------------
    // Flow
    // ---------------------------
    function resetUIForNewQuestion() {
      resultEl.textContent = "";
      resultEl.classList.remove("ok","bad");
      correctValEl.textContent = "";
      answerEl.value = "";
      checkBtn.disabled = true;
      nextBtn.disabled = true;
      answerEl.removeAttribute("disabled");
      answerEl.focus();
    }

    function generateQuestion() {
      current = generateOperands();
      renderQuestion();
      updateAnswerConstraints();
      resetUIForNewQuestion();
      startTimer();
    }

    function checkAnswer() {
      const val = parseInt(answerEl.value, 10);
      const correct = (val === current.answer);
      stopTimer();
      stats.total += 1;
      if (correct) {
        stats.correct += 1;
        resultEl.textContent = "Correct!";
        resultEl.classList.add("ok");
        resultEl.classList.remove("bad");
        correctValEl.textContent = "";
      } else {
        stats.incorrect += 1;
        resultEl.textContent = "Try again";
        resultEl.classList.add("bad");
        resultEl.classList.remove("ok");
        correctValEl.textContent = `Correct answer: ${current.answer}`;
      }
      renderStats();
      saveStats();
      checkBtn.disabled = true;
      nextBtn.disabled = false;
      answerEl.setAttribute("disabled","true");
    }

    function handleNext() { generateQuestion(); }

    // ---------------------------
    // Init & events
    // ---------------------------
    function initDigitSelector() {
      updateDigitUI();
      const sel = document.getElementById("digitSelect");
      const msel = document.getElementById("multiplierDigitSelect");
      sel.addEventListener("change", () => {
        digitCount = parseInt(sel.value, 10);
        localStorage.setItem(STORAGE.digitCount, String(digitCount));
        updateDigitUI();
        generateQuestion();
      });
      msel.addEventListener("change", () => {
        multiplierDigitCount = parseInt(msel.value, 10);
        localStorage.setItem(STORAGE.multiplierDigitCount, String(multiplierDigitCount));
        updateDigitUI();
        generateQuestion();
      });
    }

    function initModes() {
      const btnAdd = document.getElementById("mode-add");
      const btnSub = document.getElementById("mode-sub");
      const btnMul = document.getElementById("mode-mul");
      const btnBoth = document.getElementById("mode-both");
      const btnAll = document.getElementById("mode-all");
      function setMode(newMode) {
        mode = newMode;
        localStorage.setItem(STORAGE.mode, newMode);
        updateModeUI();
        generateQuestion();
      }
      btnAdd.addEventListener("click", () => setMode(Modes.ADD));
      btnSub.addEventListener("click", () => setMode(Modes.SUB));
      btnMul.addEventListener("click", () => setMode(Modes.MUL));
      btnBoth.addEventListener("click", () => setMode(Modes.BOTH));
      btnAll.addEventListener("click", () => setMode(Modes.ALL));
      updateModeUI();
    }

    function initAnswerFlow() {
      checkBtn.addEventListener("click", checkAnswer);
      nextBtn.addEventListener("click", handleNext);
      answerEl.addEventListener("input", () => { checkBtn.disabled = (answerEl.value.trim() === ""); });
      answerEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          if (!checkBtn.disabled) checkBtn.click();
          else if (!nextBtn.disabled) nextBtn.click();
        }
      });
    }

    function initStats() {
      renderStats();
      document.getElementById("resetStats").addEventListener("click", () => {
        stats = { ...defaultStats };
        saveStats();
        renderStats();
      });
    }

    function initPad() {
      if (!canvas) return;
      const ensureSized = () => { resizeCanvasToCSS(); };
      ensureSized();
      window.addEventListener("resize", ensureSized);
      setStrokeWidth(parseInt(sizeInput.value, 10) || 10);
      sizeInput.addEventListener("input", () => setStrokeWidth(parseInt(sizeInput.value, 10)));

      const start = (e) => { drawing = true; last = getPoint(e); e.preventDefault(); };
      const move = (e) => {
        if (!drawing) return;
        const p = getPoint(e);
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
        e.preventDefault();
      };
      const end = (e) => { drawing = false; last = null; e.preventDefault(); };

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      window.addEventListener("mouseup", end);
      canvas.addEventListener("touchstart", start, { passive:false });
      canvas.addEventListener("touchmove", move, { passive:false });
      canvas.addEventListener("touchend", end, { passive:false });
      canvas.addEventListener("touchcancel", end, { passive:false });
      clearPadBtn.addEventListener("click", clearDrawingArea);
    }

    // Optional: read ?digits=..&multiplierDigits=..
    (function readDigitsFromURL() {
      const p = new URLSearchParams(window.location.search);
      const d = parseInt(p.get("digits"), 10);
      if ([1,2,3,4].includes(d)) {
        digitCount = d;
        localStorage.setItem(STORAGE.digitCount, String(digitCount));
      }
      const m = parseInt(p.get("multiplierDigits"), 10);
      if ([1,2,3,4].includes(m)) {
        multiplierDigitCount = m;
        localStorage.setItem(STORAGE.multiplierDigitCount, String(multiplierDigitCount));
      }
    })();

    // Tabs switching
    (function(){
      const tabs = document.querySelectorAll('.tab');
      const panes = document.querySelectorAll('.tab-content');
      function activate(id) {
        tabs.forEach((b) => {
          const active = b.getAttribute('data-tab') === id;
          b.classList.toggle('active', active);
          b.setAttribute('aria-selected', String(active));
        });
        panes.forEach((p) => p.classList.toggle('active', p.id === id));
        if (id === 'draw' && typeof resizeCanvasToCSS === 'function') {
          setTimeout(resizeCanvasToCSS, 50);
        }
      }
      tabs.forEach((btn) => btn.addEventListener('click', () => activate(btn.getAttribute('data-tab'))));
      activate('practice');
    })();

    // Boot
    document.addEventListener("DOMContentLoaded", () => {
      initDigitSelector();
      initModes();
      initAnswerFlow();
      initStats();
      initPad();
      generateQuestion();
    });
  </script>
</body>
</html>
